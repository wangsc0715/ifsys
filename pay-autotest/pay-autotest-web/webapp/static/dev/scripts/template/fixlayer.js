/** * Created by marszed on 16/3/10. */define(function(require, exports, module) {	var template = require('template'),		$ = require('jquery'),		common = require('common'),		GiGoldPay = new common.GiGoldPay(),		rerLock = false,		addLock = false,		delLock = false,		saveLock = false,		proLock = false,		searchLock = false,		layer = require('layer'),		tableLock = false;//数据表锁	var $fixLayer = $('#fixLayer');	$('.close-box').click(function(){		$fixLayer.toggleClass('hide');		var mockid = $('#addRelateModule').attr('mockid');		//刷新当前用例信息		$('#interfaceInfo').find('.ct-active').click();	});	//打开接口依赖管理界面	$('#addRelateModule').click(function(){		var mockid = $('#addRelateModule').attr('mockid');		if(mockid){			$fixLayer.toggleClass('hide');			fixUpdateTable.getTableData(mockid);		} else {			layer.tips('请先选择测试用例',$(this));		}	});	//新增接口依赖	$('#fixTable').on('click','.addUnit',function(){		var $this = $(this),			mockId = $('#addRelateModule').attr('mockid'),			refMockId = $this.attr('refMockId');		if(mockId && refMockId){			fixUpdateTable.addRelate({				data: {					mockId: mockId + '',					refMockId: refMockId + ''				}			});		} else {			layer.tips('新增失败,缺少数据', $this);			console.log('mockId:'+mockId+'\nrefMockId:'+refMockId);		}	});	//删除接口依赖	$('#refTable').on('click','.delUnit',function(){		var $this = $(this),			id = $this.parents('tr').attr('addId');		if(id){			fixUpdateTable.delRelate({				data: {					id: id + '',					that: $this				}			});		} else {			layer.tips('删除失败,缺少id', $this);		}	});	//保存接口依赖顺序	$('#refTable').on('click','.saveUnit',function(){		var $this = $(this),			id = $this.parents('tr').attr('addId');		if(id){			fixUpdateTable.saveRelate({				data: {					id: id + '',					ordNum: $this.parents('tr').find('.orderByNum').val()+''				}			});		} else {			layer.tips('保存失败,缺少id', $this);		}	});	//选择系统	$fixLayer.on('click','.fixSysList > li > a',function(){		var $this = $(this),			sysid = $this.attr('sysid')-0;		if(sysid){			$fixLayer.find('.fixSysListBtn').html($this.html()+'&nbsp;<span class="caret" sid='+sysid+'></span>');			//渲染数据表+分页			fixUpdateTable.renderTable({				data:{					ifName: "",					ifProId: "0",					ifSysId: sysid+"",					pageNum: 1,					pageSize: 8				}			});			//渲染产品列表			fixUpdateTable.renderProInfo({				data: {					interFacePro: {sysId: sysid}				}			});		}	});	//选择产品 -> 更新接口信息列表	$fixLayer.on('click','.fixProList > li > a',function(){		var $this = $(this),			sysid = $this.attr('sysid');		if(sysid){			$fixLayer.find('.fixProListBtn').html($this.html()+'&nbsp;<span class="caret"></span>').attr('proid',$this.attr('proid'));			//渲染数据表+分页			fixUpdateTable.renderTable({				data:{					ifName: "",					ifProId: $this.attr('proid')+"",					ifSysId: sysid+"",					pageNum: 1,					pageSize: 8				}			});		}	});	//输入关键字	$('#searchBtn').click(function(){		var $this = $(this),			val = $('#searchInput').val(),			proId = $('.fixProListBtn').attr('proid'),			sysId = $('.fixSysListBtn').find('.caret').attr('sid');		if(val){			//渲染数据表+分页			fixUpdateTable.renderTable({				data:{					ifName: val+"",					ifProId: proId || "",					ifSysId: sysId || "",					pageNum: 1,					pageSize: 8				}			});		} else {			layer.tips('缺少检索关键字',$this);		}	});	//回车搜索	$fixLayer.keydown(function(event){		if (event.which == 13) {			var $this = $('#searchBtn'),				val = $('#searchInput').val(),				proId = $('.fixProListBtn').attr('proid'),				sysId = $('.fixSysListBtn').find('.caret').attr('sid');			if(val){				//渲染数据表+分页				fixUpdateTable.renderTable({					data:{						ifName: val+"",						ifProId: proId || "",						ifSysId: sysId || "",						pageNum: 1,						pageSize: 8					}				});			} else {				layer.tips('缺少检索关键字',$this);			}		}	});	//分页	$fixLayer.on('click','.pagination > li > a',function(){		var pageNum = $(this).attr('pageNum'),			proid = $('.fixProListBtn').attr('proid'),			sysid = $('.fixSysListBtn').find('.caret').attr('sid');		if(pageNum){			//渲染数据表+分页			fixUpdateTable.renderTable({				data:{					ifName: $('#searchInput').val()+"",					ifProId: proid ? (proid+"") : "0",					ifSysId: sysid ? (sysid+"") : "0",					pageNum: pageNum - 0,					pageSize: 8				}			});		} else {			layer.tips('没有页码数信息',$(this));		}	});	function useCaseDetail(){}	useCaseDetail.prototype.getTableData = function(mockid){		fixUpdateTable.renderTable({			data:{				pageNum: 1,				pageSize: 8			}		});		fixUpdateTable.renderRerTable({			data:{				mockId: mockid			}		});	};	//根据系统id获取产品信息	useCaseDetail.prototype.renderProInfo = function(obj) {		if (!proLock) {			proLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit() + "/autotest/getProInfoBySysId.do",				"data": obj.data || {},				"onSuccess": function (data) {					if (data.rspCd == "00000") {						proLock = false;						//渲染产品列表						var fixHtml = template('fixProBox',data);						document.getElementById('fixChoosePro').innerHTML = fixHtml;					} else {						GiGoldPay.cancleLock(proLock);					}				},				"onError": function (data) {					GiGoldPay.cancleLock(proLock);				}			});		}	};	//获取查询数据表信息	useCaseDetail.prototype.renderTable = function(obj){		if(!tableLock){			tableLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/autotest/getmockbypage.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						tableLock = false;						//渲染数据表格						var tableHtml = template('fixTableBox',data.pageInfo);						document.getElementById('fixTable').innerHTML = tableHtml;						//渲染分页						var pageHtml = template('fixPageBox',data.pageInfo);						document.getElementById('fixPage').innerHTML = pageHtml;					}else{						GiGoldPay.cancleLock(tableLock);					}				},				'onError': function(data){					GiGoldPay.cancleLock(tableLock);				}			});		}	};	//获取依赖列表信息	useCaseDetail.prototype.renderRerTable = function(obj){		if(!rerLock){			rerLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/getreferList.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						rerLock = false;						//渲染弹层依赖表格						var fixHtml = template('refTableBox',data);						document.getElementById('refTable').innerHTML = fixHtml;					}else{						GiGoldPay.cancleLock(rerLock);					}				},				'onError': function(data){					GiGoldPay.cancleLock(rerLock);				}			});		}	};	//新增依赖关系	useCaseDetail.prototype.addRelate = function(obj){		console.log(obj);		if(!addLock){			addLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/addmockrefer.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						fixUpdateTable.renderRerTable(obj);						layer.msg('添加接口依赖成功');						addLock = false;					}else{						layer.msg('添加接口依赖失败');						GiGoldPay.cancleLock(addLock);					}				},				'onError': function(data){					GiGoldPay.cancleLock(addLock);				}			});		}	};	//更新产品信息	useCaseDetail.prototype.updateProInfo = function(obj){		if(!proLock){			proLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/getProInfoBySysId.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						proLock = false;						if(data.proList.length){							//渲染弹层模版->产品							//var html = template('fixProBox',data);							//document.getElementById('fixChoosePro').innerHTML = html;							//renderByJson(data.proList);						}					} else {						GiGoldPay.cancleLock(proLock);					}				},				"onError": function(data){					GiGoldPay.cancleLock(proLock);				}			});		}	};	useCaseDetail.prototype.delRelate = function(obj){		if(!delLock){			delLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/deletemockrefer.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						obj.data.that.parents('tr').remove();						layer.msg('删除接口依赖成功');						delLock = false;					}else{						layer.msg('删除接口依赖失败');						GiGoldPay.cancleLock(delLock);					}				},				'onError': function(data){					GiGoldPay.cancleLock(delLock);				}			});		}	};	useCaseDetail.prototype.saveRelate = function(obj){		if(!saveLock){			saveLock = true;			GiGoldPay.ajaxHandler({				"url": obj.url || GiGoldPay.ipBullShit()+"/autotest/updpatemockrefer.do",				"data": obj.data || {},				"onSuccess":function(data){					if (data.rspCd == "00000") {						layer.msg('保存接口依赖成功');						saveLock = false;					}else{						layer.msg('保存接口依赖失败');						GiGoldPay.cancleLock(saveLock);					}				},				'onError': function(data){					GiGoldPay.cancleLock(saveLock);				}			});		}	};	//左侧侧栏接口列表初始化	var fixUpdateTable = new useCaseDetail();	module.exports = {		useCaseDetail: useCaseDetail	};});